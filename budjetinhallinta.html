<!DOCTYPE html>

<html lang="en" xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css">
    <script src="https://code.jquery.com/jquery-3.1.0.js"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>
    <title>Varastokirjanpito</title>
    <style>
        .ui-widget-overlay {
            opacity: 1;
        }
        .ui-dialog-titlebar-close {
            visibility: hidden;
        }        
        
        table, th, td {
            border: 1px solid #000;
        }
        th, td {
            padding: 5px;
            text-align: center;
        }

        #lisays {
            margin: 1em;
        }
        #dialogi {
            display: none;
        }
        #dialogi input[type="text"] {
            display: block;
        }

        fieldset.scheduler-border {
            border: solid 1px #DDD !important;
            padding: 0 10px 10px 10px;
            border-bottom: none;
        }

        legend.scheduler-border {
            width: auto;
            border: none;
            font-size: 14px;
        }

        .left-block{
            float:left;
        }

        .right-block{
            float:right;
        }
    </style>
    <script>
        $(document).ready(function () {
            var varasto = "http://localhost:3000/api/varasto_riistavesi/";
            var toiminto;
            haeTuotteet(varasto);
            haeYksikkotyypit();
            haeSijainti();

            $("#hakulomake").submit(function(event) {
                var hakulauseke = $(this).serializeArray();
                if (hakulauseke[hakulauseke.length-1]["value"] == "") {
                    hakulauseke.pop();
                }
                console.log("Hakulauseke: " + $.param(hakulauseke));
                haeTuotteet(varasto, $.param(hakulauseke));
                event.preventDefault();
            });

            // Dialogi tuotteiden lisäykselle ja muokkaukselle.
            $("#dialogi").dialog({
                    autoOpen: false,
                    buttons: [
                        {
                            id: "dialogiNappi",
                            text: "Muokkaa",
                            click: function() {
                                if ($.trim($("#nimi_lisays").val()) === "" || $.trim($("#maara_lisays").val()) === "" || $.trim($("#yksikkotyyppi_lisays").val()) === "" || $.trim($("#yksikkohinta_lisays").val()) === "" || $.trim($("#sijainti_lisays").val()) === "") {
                                    alert("Anna arvo kaikki kenttiin!");
                                    return false;
                                } else {
                                    var toiminto = $("#dialogiNappi").html();
                                    $("#saldo_lisays").val((document.getElementById("maara_lisays").value)*(document.getElementById("yksikkohinta_lisays").value));
                                    var lauseke = $("#lisayslomake").serialize();

                                    console.log("Muokkauslauseke: " + lauseke);
                                    muokkaaTuotetta(varasto, lauseke, $("#ID_muokkaus").val());

                                    $("#lisayslomake")[0].reset();
                                    $("#yksikkotyyppi_lisays").prepend('<option value=""></option>');
                                    $("#sijainti_lisays").prepend('<option value=""></option>');
                                    $("#yksikkotyyppi_lisays").prop('selectedIndex', 0);
                                    $("#sijainti_lisays").prop('selectedIndex', 0);
                                    $(this).dialog("close");
                                }
                            },
                        },
                        {
                            text: "Peruuta",
                            click: function() {
                                $("#lisayslomake")[0].reset();
                                $("#yksikkotyyppi_lisays").prepend('<option value=""></option>');
                                $("#sijainti_lisays").prepend('<option value=""></option>');
                                $("#yksikkotyyppi_lisays").prop('selectedIndex', 0);
                                $("#sijainti_lisays").prop('selectedIndex', 0);
                                $(this).dialog("close");
                            },
                        }
                    ],
                    closeOnEscape: false,
                    draggable: false,
                    modal: true,
                    resizable: false
            });

            $("#lisays").click(function() {
                $("#dialogi").dialog("open");
            });

            $("#riistavesi").click(function() {
                varasto = "http://localhost:3000/api/varasto_riistavesi/";
                haeTuotteet(varasto);
            });

            $("#melalahti").click(function() {
                varasto = "http://localhost:3000/api/varasto_melalahti/";
                haeTuotteet(varasto);
            });
        });

        function haeYksikkotyypit() {
            $.get(
                "http://localhost:3000/api/varastokirjanpito/yksikkotyyppi" 
            ).done(function (data, textStatus, jqXHR) {
                data.forEach(function (yksikko) {
                    $('#yksikkotyyppi_haku')
                        .append($("<option></option>")
                            .attr("value", yksikko.ID)
                            .text(yksikko.nimi));
                    $('#yksikkotyyppi_lisays')
                        .append($("<option></option>")
                            .attr("value", yksikko.ID)
                            .text(yksikko.nimi));
                });
            }).fail(function (jqXHR, textStatus, errorThrown) {
                console.log("status=" + textStatus + ", " + errorThrown);
            });
        }

        function haeSijainti() {
            $.get(
                "http://localhost:3000/api/varastokirjanpito/sijainti" 
            ).done(function (data, textStatus, jqXHR) {
                data.forEach(function (sijainti) {
                    $('#sijainti_haku')
                        .append($("<option></option>")
                            .attr("value", sijainti.ID)
                            .text(sijainti.nimi));
                    $('#sijainti_lisays')
                        .append($("<option></option>")
                            .attr("value", sijainti.ID)
                            .text(sijainti.nimi));
                });
            }).fail(function (jqXHR, textStatus, errorThrown) {
                console.log("status=" + textStatus + ", " + errorThrown);
            });
        }


        // Haetaan tiedot tietokannasta.
        function haeTuotteet(varasto, hakulauseke) {
            $.get(varasto + "haku", hakulauseke).done(function(data, textStatus, jqXHR) {
                $("#tuotteet").empty(); 

                var tuotteet = document.getElementById("tuotteet");
                var varastonSaldo = 0;
                if (data.length == 0) {
                    rivi = tuotteet.insertRow(-1);
                    rivi.insertCell(-1).outerHTML = "<td colspan=\"9\">Hakuehtojasi vastaavia tuotteita ei löytynyt.</td>";
                } else {
                    data.forEach(function (tuote) {
                        rivi = tuotteet.insertRow(-1);
                        rivi.insertCell(-1).outerHTML = "<td>" + tuote.ID + "</td>";
                        rivi.insertCell(-1).outerHTML = "<td>" + tuote.nimi + "</td>";
                        rivi.insertCell(-1).outerHTML = "<td>" + tuote.maara + "</td>";
                        rivi.insertCell(-1).outerHTML = "<td>" + tuote.yksikkotyyppi_ID + "</td>";
                        rivi.insertCell(-1).outerHTML = "<td>" + tuote.yksikkohinta + " €" + "</td>";
                        rivi.insertCell(-1).outerHTML = "<td>" + tuote.sijainti_ID + "</td>";
                        rivi.insertCell(-1).outerHTML = "<td>" + tuote.saldo + " €" + "</td>";
                        rivi.insertCell(-1).outerHTML = "<td>" + "kulutuksen määrä(kk)" + "</td>";
                        rivi.insertCell(-1).outerHTML = "<td>" + "kulutuksen hinta" + "</td>";
                        rivi.insertCell(-1).outerHTML = "<td><button onclick=\"poistaTuote(" + "'" + varasto + "'" + "," + "'" + tuote.ID + "'" + ")\">Poista</button></td>";
                        rivi.insertCell(-1).outerHTML = "<td><button onclick=\"muokkausLomake(" + "'" + varasto + "'" + "," + "'" + tuote.ID + "'" + ")\">Muokkaa</button></td>";
                        varastonSaldo = varastonSaldo + tuote.saldo;
                    });
                }
            }).fail(function (jqXHR, textStatus, errorThrown) {
                console.log("status=" + textStatus + ", " + errorThrown);
            });
        }
        
        // Muokataan tuotteita.
        function muokkausLomake(varasto, ID) {
            $.get(
                varasto + ID,
            ).done(function (data, textStatus, jqXHR) {
                if (data.hasOwnProperty('status') && data.status === "not ok") {
                    alert("Tuotteen (ID: " + ID + ") tietojen haku ei onnistunut: " + data.status_text);
                }

                if (data.length == 0) {
                    alert("ID " + ID + " ei löytynyt yhtään tuotetta!");
                } else {
                    $("#dialogi").dialog("option", "title", "Muokkaa tuotteen tietoja");
                    $("#dialogiNappi").html("Muokkaa");
                    $("#lisayslomake").prepend('<input type="hidden" ID="ID_muokkaus" name="ID" value="' + data[0].ID + '" readonly="readonly">');

                    $("#yksikkotyyppi_lisays option[value='']").remove();
                    $("#sijainti_lisays option[value='']").remove();

                    $("#nimi_lisays").html(data[0].nimi);
                    $("#maara_lisays").html(data[0].maara);
                    $("#yksikkohinta_lisays").html(data[0].yksikkohinta);
                    $("#saldo_lisays").html(data[0].maara*data[0].yksikkohinta);


                    $("#dialogi").dialog("open");
                }
            }).fail(function (jqXHR, textStatus, errorThrown) {
                console.log("status=" + textStatus + ", " + errorThrown);
            });
        }

        function muokkaaTuotetta(varasto, muokkauslauseke, ID) {
            $.ajax({
                url: varasto + ID,
                method: 'post',
                data: muokkauslauseke,
                success: function (data, status, jqXHR) {
                    if (data.hasOwnProperty('status') && data.status === "not ok") {
                        alert("Muokkaus ei onnistunut: " + data.status_text);
                    }
                    $("#hakulomake")[0].reset();
                    $("#yksikkotyyppi_lisäys").prop('selectedIndex', 0);
                    $("#sijainti_lisäys").prop('selectedIndex', 0);
                    $("#hakulomake").submit();
                },
                error: function (jqXHR, textStatus, errorThrown) {
                    console.log("status=" + textStatus + ", " + errorThrown);
                }
            });
        }
      
    </script>
</head>
<body>

    <nav class="navbar navbar-inverse">
        <div class="container-fluid">
          <ul class="nav navbar-nav">
            <li><a href="/home">Varastonhallinta</a></li>
            <li class="active"><a href="/budjetinhallinta">Budjetinhallinta</a></li>
            <li><a href="/tilaukset">Tilaukset</a></li>
          </ul>
          <ul class="nav navbar-nav navbar-right">
            <li class="dropdown"><a class="dropdown-toggle" data-toggle="dropdown" href="#">Koulu<span class="caret"></span></a>
                <ul class="dropdown-menu">
                  <li><a href="#riistavesi" id="riistavesi">Riistaveden koulu</a></li>
                  <li><a href="#melalahti" id="melalahti">Melalahden koulu</a></li>
                </ul>
              </li>
              <li><a href="/logout">Kirjaudu ulos</a></li>
          </ul>
        </div>
      </nav>

    <div class="container">
    <form id="hakulomake">
        <fieldset class="scheduler-border">
            <legend class="scheduler-border">Hakuehdot</legend>
            <div>
                <label for="nimi_haku">Tuote:</label>
                <input type="text" id="nimi_haku" name="nimi">
                <label for="sijainti_haku">Sijainti:</label>
                <select id="sijainti_haku" name="sijainti_ID">
                    <option value=""></option>
                </select>
                <label for="kuukausi_haku">Kuukausi:</label>
                <select id="kuukausi_haku" name="kuukausi">
                    <option value=""></option>
                    <option value="1">1</option>
                    <option value="2">2</option>
                    <option value="3">3</option>
                    <option value="4">4</option>
                    <option value="5">5</option>
                    <option value="6">6</option>
                    <option value="7">7</option>
                    <option value="8">8</option>
                    <option value="9">9</option>
                    <option value="10">10</option>
                    <option value="11">11</option>
                    <option value="12">12</option>
                </select>
                <input type="submit" value="Hae">
            </div>
        </fieldset>
    </form>
    </div>


    <div class="container">
    <table class="table table-striped table-bordered table-hover table-condensed table-responsive">
        <thead>
            <tr>
                <th>ID</th>
                <th>Nimi</th>
                <th>Määrä</th>
                <th>Yksikkö</th>
                <th>Yksikköhinta</th>
                <th>Sijainti</th>
                <th>Saldo</th>
                <th>Kulutus (Kuukaudessa)</th>
                <th>Kulutuksen hinta (Kuukaudessa)</th>
                <th colspan="2"></th>
            </tr>  
        </thead>          
        <tbody id="tuotteet">
            <tr>
                <td colspan="9">Aseta haluamasi hakuehdot ylläolevaan lomakkeeseen ja paina Hae-nappia.</td>
            </tr>
        </tbody>
    </table>

    <div id="dialogi" title="Muokkaa tuotteen kulutustietoja">
        <form id="lisayslomake">
            <label for="nimi_lisays">Tuote:</label>
            <p id="nimi_lisays" name="nimi"></p>
            <label for="maara_lisays">maara:</label>
            <p id="maara_lisays" name="maara"></p>
            <label for="yksikkohinta_lisays">Yksikköhinta (€):</label>
            <p id="yksikkohinta_lisays" name="yksikkohinta"></p>
            <label for="saldo_lisays">Saldo (€):</label>
            <p id="saldo_lisays" name="saldo"></p>
            <select id="kuukausi_lisays" name="kuukausi">
                <option value=""></option>
                <option value="1">1</option>
                <option value="2">2</option>
                <option value="3">3</option>
                <option value="4">4</option>
                <option value="5">5</option>
                <option value="6">6</option>
                <option value="7">7</option>
                <option value="8">8</option>
                <option value="9">9</option>
                <option value="10">10</option>
                <option value="11">11</option>
                <option value="12">12</option>
            </select>
            <input type="text" id="kulutus_lisays" name="kulutusKuukaudessa" placeholder="Kulutus kuukaudessa (kpl/m)">
            <input type="hidden" id="kulutusHinta_lisays" name="kulutusHinta">
        </form>
    </div>
    
</body>
</html>